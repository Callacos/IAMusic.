<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IAMusic</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
<div class="page-wrapper">
  <div class="logo-container">
    <img src="{{ url_for('static', filename='image/logo.png') }}" alt="IAMusic Logo" class="iamusic-logo" />
    <div class="logo-reflet"></div>
  </div>
  <main>
    <h1>Quelle est ton humeur ?</h1>
    <form id="phraseForm">
      <input type="text" id="phraseInput" placeholder="Ex: Je veux me relaxer apr√®s le travail" required />
      <button type="submit">Envoyer</button>
    </form>
    <div id="resultat"></div>

    <div class="menu-container">
      <button class="menu-button" onclick="toggleMenu()">‚ò∞</button>
      <div id="dropdown-menu" class="dropdown-content">
        <a href="/logout">D√©connexion</a>
        <form action="{{ url_for('delete_account') }}" method="POST" onsubmit="return confirm('‚ö†Ô∏è Es-tu s√ªr de vouloir supprimer ton compte ? Cette action est irr√©versible.')">
      <button type="submit" class="dropdown-delete">Supprimer mon compte</button>
     </form>

        <!-- Tu pourras ajouter ici d‚Äôautres options plus tard -->
      </div>
    </div>

    <div class="user-info">
    Bonjour, {{ display_name }} üëã
    </div>
    
  </main>

  <script>
    document.getElementById("phraseForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const phrase = document.getElementById("phraseInput").value;

      const response = await fetch("http://127.0.0.1:5000/phrase", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phrase: phrase })
      });

      const data = await response.json();
      const resultatDiv = document.getElementById("resultat");

      if (data.uri) {
        resultatDiv.innerHTML = `üéß Playlist lanc√©e : <code>${data.uri}</code>`;
      } else {
        resultatDiv.innerHTML = "‚ùå Aucune playlist trouv√©e.";
      }
    });
  </script>

<script>
  function toggleMenu() {
    const menu = document.getElementById("dropdown-menu");
    menu.classList.toggle("show");
  }

  // Ferme le menu si on clique ailleurs
  window.onclick = function(event) {
    if (!event.target.matches('.menu-button')) {
      const dropdowns = document.getElementsByClassName("dropdown-content");
      for (let i = 0; i < dropdowns.length; i++) {
        const openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }
</script>


<!-- üéß Mini lecteur Spotify -->
<section class="spotify-player">
  <div id="track-info">
    <img id="album-cover" src="" alt="Album" />
    <div>
      <div id="track-name">Titre</div>
      <div id="track-artist">Artiste</div>
    </div>
  </div>
  <div id="controls">
    <button onclick="previousTrack()">‚èÆÔ∏è</button>
    <button onclick="togglePlay()">‚èØÔ∏è</button>
    <button onclick="nextTrack()">‚è≠Ô∏è</button>
  </div>
  <input type="range" id="progress-bar" value="0" min="0" max="100" />
</section>



 <!--artiste de la semaine -->
{% if artiste %}
<section class="artiste-semaine">
  <h2>üé§ Artiste de la semaine</h2>
  <div class="artiste-contenu">
    <img src="{{ artiste.image }}" alt="{{ artiste.nom }}" class="artiste-img">
    <div class="artiste-nom">{{ artiste.nom }}</div>
    <div class="artiste-info">
      <div class="titres-albums">
        <div class="titres">
          <h4>Titres populaires</h4>
          <ul>
            {% for titre in artiste.titres %}
              <li><a href="https://open.spotify.com/track/{{ titre.uri | replace('spotify:track:', '') }}" target="_blank">{{ titre.nom }}</a></li>
            {% endfor %}
          </ul>
        </div>
        <div class="albums">
          <h4>Albums</h4>
          <ul>
            {% for album in artiste.albums %}
              <li>
            <a href="https://open.spotify.com/album/{{ album.uri | replace('spotify:album:', '') }}" target="_blank">
            <img src="{{ album.image }}" alt="{{ album.nom }}" class="album-cover">
           <span>{{ album.nom }}</span>
            </a>
          </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<script>
let deviceId = null;
let player = null;

window.onSpotifyWebPlaybackSDKReady = () => {
const token = "{{ spotify_token }}";
  player = new Spotify.Player({
    name: 'IAMusic Web Player',
    getOAuthToken: cb => { cb(token); },
    volume: 0.8
  });

  player.addListener('ready', ({ device_id }) => {
    deviceId = device_id;
    console.log('Appareil pr√™t :', device_id);
    // Active automatiquement ce device
    fetch("https://api.spotify.com/v1/me/player", {
      method: "PUT",
      body: JSON.stringify({ device_ids: [deviceId], play: true }),
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    });
  });

  player.addListener('player_state_changed', state => {
    if (!state) return;
    document.getElementById("track-name").innerText = state.track_window.current_track.name;
    document.getElementById("track-artist").innerText = state.track_window.current_track.artists.map(a => a.name).join(", ");
    document.getElementById("album-cover").src = state.track_window.current_track.album.images[0].url;
    document.getElementById("progress-bar").value = (state.position / state.duration) * 100;
  });

  player.connect();
};
 setInterval(() => {
    if (player) {
      player.getCurrentState().then(state => {
        if (!state) return;
        const progress = state.position;
        const duration = state.duration;
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
          progressBar.value = (progress / duration) * 100;
        }
      });
    }
  }, 1000);

const progressBar = document.getElementById('progress-bar');
  progressBar.addEventListener('input', (e) => {
    player.getCurrentState().then(state => {
      if (!state) return;
      const newPos = (e.target.value / 100) * state.duration;
      player.seek(newPos);
    });
  });


function togglePlay() {
  player.togglePlay();
}
function nextTrack() {
  player.nextTrack();
}
function previousTrack() {
  player.previousTrack();
}
</script>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

</body>
</html>
